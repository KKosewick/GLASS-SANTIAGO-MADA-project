---
title: "Statistical Analysis Script"
author: "Taylor Glass and Arlyn Santiago"
date: "03/12/24"
output: html_document
---
## Load necessary packages
```{r}
#| message: false
library(broom) #for cleaning up output from lm()
library(here) #for data loading/saving
library(tidymodels) # for model building 
```

## Load the cleaned data
```{r}
#path to data
data_location <- here("data","processed-data","processeddata.rds")
#load data
mydata <- readRDS(data_location)
```

## Data fitting and statistical analysis 
The outcome of interest in all of the following models is the percentage of unintended pregnancies associated with usage of short acting reversible contraception methods. The predictors used in our models include total number of women using short acting reversible methods standardized by population size, region, percent of women currently married, percent of women never married, total rate of maternal deaths, rate of maternal deaths due to unintended pregnancy, and rate of maternal deaths due to abortion. We are considering adding another predictor using a political freedom index for each country.

### First Model Fit 
The second model attempts to predict the percentage of unintended pregnancies among women using short acting reversible methods of contraception 'pct_upreg_sarc' based on the total number of women using this method of contraception. We will use the version of the variable that has been standardized by population size, 'sarc_standard'. 
```{r}
# fit linear model using pct_upreg_sarc as outcome, sarc_standard as predictor
lm_mod <- linear_reg() #specify the type of model
lmfit1 <- lm_mod %>% 
            fit(pct_upreg_sarc ~ sarc_standard, mydata) #estimate/train the model 

#generate clean output with estimates and p-values
tidy(lmfit1) 

# save results from fit into a data frame 
lmtable1 <- tidy(lmfit1)

# save fit results table  
table_file1 = here("results", "resulttable1.rds")
saveRDS(lmtable1, file = table_file1)
```
There appears to be a very strong relationship between total number of women using this birth control method and the outcome based on the coefficient estimate of 87.65998.

### Second Model Fit 
```{r}
# fit linear model using pct_upreg_sarc as outcome, region as predictor
lm_mod <- linear_reg() #specify the type of model
lmfit2 <- lm_mod %>% #estimate/train the model 
            fit(pct_upreg_larcster ~ region, mydata)      

#generate clean output with estimates and p-values
tidy(lmfit2) 

# save results from fit into a data frame 
lmtable2 <- tidy(lmfit2)

# save fit results table  
table_file2 = here("results", "resulttable2.rds")
saveRDS(lmtable2, file = table_file2)
```
This model shows that the Latin America/the Carribean region has the strongest association with the outcome variable based on a coefficient estimate of 1.6218844 followed closely by the Asia region. The Oceania region has the weakest association with the outcome variable based on a coefficient estimate of 0.2512100.

### Third Model Fit 
```{r}
# fit linear model using pct_upreg_sarc as outcome, pct_currentlymarried as predictor
lm_mod <- linear_reg() #specify the type of model
lmfit3 <- lm_mod %>% #estimate/train the model 
            fit(pct_upreg_sarc ~ pct_currentlymarried, mydata)      

#generate clean output with estimates and p-values
tidy(lmfit3) 

# save results from fit into a data frame 
lmtable3 <- tidy(lmfit3)

# save fit results table  
table_file3 = here("results", "resulttable3.rds")
saveRDS(lmtable3, file = table_file3)
```
This model shows there is a negative relationship between the number of women currently married and the outcome. As the percentage of currently married women increases by 1, the percentage of unintended pregnancies decreases by a factor of 0.4181571.

# Fourth Model Fit 
```{r}
# fit linear model using pct_upreg_sarc as outcome, pct_nevermarried as predictor
lm_mod <- linear_reg() #specify the type of model
lmfit4 <- lm_mod %>% #estimate/train the model 
            fit(pct_upreg_sarc ~ pct_nevermarried, mydata)      

#generate clean output with estimates and p-values
tidy(lmfit4) 

# save results from fit into a data frame 
lmtable4 <- tidy(lmfit4)

# save fit results table  
table_file4 = here("results", "resulttable4.rds")
saveRDS(lmtable4, file = table_file4)
```
This model shows a positive relationship between the percentage of women never married and the outcome. As the percentage of women never married increases by 1, the percentage of unintended pregnancies increases by a factor of 0.2474218.  

# Fifth Model Fit 
```{r}
# fit linear model using pct_upreg_sarc as outcome, rate_matdeaths as predictor
lm_mod <- linear_reg() #specify the type of model
lmfit5 <- lm_mod %>% #estimate/train the model 
            fit(pct_upreg_sarc ~ rate_matdeaths, mydata)      

#generate clean output with estimates and p-values
tidy(lmfit5) 

# save results from fit into a data frame 
lmtable5 <- tidy(lmfit5)

# save fit results table  
table_file5 = here("results", "resulttable5.rds")
saveRDS(lmtable5, file = table_file5)
```
This model shows that total rate of maternal deaths is slightly negatively correlated with the outcome based on a small coefficient estimate of -0.01482568. 

# Sixth Model Fit 
```{r}
# fit linear model using pct_upreg_sarc as outcome, rate_matdeaths_upreg as predictor
lm_mod <- linear_reg() #specify the type of model
lmfit6 <- lm_mod %>% #estimate/train the model 
            fit(pct_upreg_sarc ~ rate_matdeaths_upreg, mydata)      

#generate clean output with estimates and p-values
tidy(lmfit6) 

# save results from fit into a data frame 
lmtable6 <- tidy(lmfit6)

# save fit results table  
table_file6 = here("results", "resulttable6.rds")
saveRDS(lmtable6, file = table_file6)
```
This model shows that total rate of maternal deaths due to unintended pregnancies has an even weaker association with the outcome based on a small coefficient estimate of -0.003158542. 

# Seventh Model Fit 
```{r}
# fit linear model using pct_upreg_sarc as outcome, rate_matdeaths_abs as predictor
lm_mod <- linear_reg() #specify the type of model
lmfit7 <- lm_mod %>% #estimate/train the model 
            fit(pct_upreg_sarc ~ rate_matdeaths_abs, mydata)      

#generate clean output with estimates and p-values
tidy(lmfit7) 

# save results from fit into a data frame 
lmtable7 <- tidy(lmfit7)

# save fit results table  
table_file7 = here("results", "resulttable7.rds")
saveRDS(lmtable7, file = table_file7)
```
This model shows that total rate of maternal deaths due to abortion has the strongest association with the outcome out of the three maternal mortality rates included based on a coefficient estimate of -0.033353527.

### Eighth Model Fit 
We will explore all 7 predictors using in a multiple linear regression model to determine how the associations  interact. 
```{r}
# fit linear model using pct_upreg_sarc as outcome with all 7 predictors
lm_mod <- linear_reg() #specify the type of model
lmfit8 <- lm_mod %>% #estimate/train the model 
            fit(pct_upreg_sarc ~ sarc_standard + region + pct_currentlymarried + pct_nevermarried + rate_matdeaths + rate_matdeaths_upreg + rate_matdeaths_abs, mydata)      

#generate clean output with estimates and p-values
tidy(lmfit8) 

# save results from fit into a data frame 
lmtable8 <- tidy(lmfit8)

# save fit results table  
table_file8 = here("results", "resulttable8.rds")
saveRDS(lmtable8, file = table_file8)
```
This model shows the strongest predictor is the number of women using short acting reversible contraception with a huge coefficient of 85.6433. The next strongest predictor is the European region followed by the Latin America/the Caribbean region and the Asia region, which is a shift from the model with the singular region predictor. The Oceania region now has a negative association with the outcome. Both of the marriage status predictors are associated with a decrease in the outcome. The coefficient estimates for the rate of maternal death due to unintended pregnancies and abortion both flipped from the single predictor models to show a positive association with the outcome. 


## Assessing Model Performance
It is important to consider appropriate metrics to measure model performance. We will use RMSE at this point to compare the model using the number of women using short acting reversible contraception predictor and the model using the percent currently married predictor. 
```{r}
# create predictions using the sarc_standard predictor model
poppred <- predict(lmfit1, new_data = mydata) %>% 
                  select(.pred)

# create a data frame with the predictions and true values of Y
popdata <- bind_cols(poppred, mydata$sarc_standard) %>%
            rename(sarc_standard = "...2")

# find RMSE and R squared to determine model fit
rmse1 <- rmse(popdata, truth = sarc_standard, estimate = .pred)

# create predictions using the pct_currentlymarriedd predictor model
marriedpred <- predict(lmfit3, new_data = mydata) %>% 
                  select(.pred)

# create a data frame with the predictions and true values of Y
marrieddata <- bind_cols(marriedpred, mydata$pct_currentlymarried) %>%
            rename(pct_currentlymarried = "...2")

# find RMSE and R squared to determine model fit
rmse2 <- rmse(marrieddata, truth = pct_currentlymarried, estimate = .pred)

# compare the metrics 
print(rmse1)
print(rmse2)
```

The RMSE metric favors the model with the total number of women using the short acting reversible contraception method over the model with the percentage of women currently married, which is to be expected.