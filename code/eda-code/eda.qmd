---
title: "Exploratory Analysis Script"
author: "Taylor Glass and Arlyn Santiago"
date: "02/21/24"
output: html_document
---

# Setup

```{r}
#load necessary packages
library(here) #for data loading/saving
library(dplyr) # for basic piping functions
library(skimr) # for summarizing data
library(ggplot2) # for visualizing data
library(gtsummary) # for creating tables
```

# Load the data

```{r}
#path to data
data_location <- here("data","processed-data","processeddata.rds")
#load data
mydata <- readRDS(data_location)
```


# Data exploration through tables
We will begin with creating a summary table of our cleaned variables using the skim()function. This provides information about each of the numeric variables including the mean, standard deviation, quartiles, missing observations, and a histogram. 

```{r}
# skim the data to create summary file
summary_df <- skim(mydata)
print(summary_df)
# save to file
summarytable_file <- here("results", "tables", "summarytable.rds")
saveRDS(summary_df, file = summarytable_file)
```

We also created a simple table with the categorical variables: `region`, `larcster_usage`, `sarc_usage`, and `none_usage`.
```{r}
# isolate categorical variables into their own data set
mydata_cat <- mydata %>% select(region, larcster_usage, sarc_usage, trad_usage, none_usage)

# create a summary table with counts of each level of each categorical variable
summary_table <- tbl_summary(mydata_cat, statistic = all_categorical() ~ "{n}")
print(summary_table)

# save to file 
summarytable_file <- here("results", "tables", "summarytablecat.rds")
saveRDS(summary_table, file = summarytable_file)
```


# Data exploration through figures

We will make histogram plots for the continuous outcomes in our dataset.

It is important to consider the type of birth control methods associated with percent of unintended pregnancies as well. We will create a histogram for the `pct_upreg_sarc` variable.  

```{r}

# Explore the percentage of unintended pregnancies related to short acting reversible methods in each country
p3 <- mydata %>% ggplot(aes(x=pct_upreg_sarc)) + 
  geom_histogram() + 
  ggtitle("Percent Unintended Pregnancy Using Short Acting Reversible Methods") + xlab("Percentage") + ylab("Number of Countries")
plot(p3)
figure_file = here("results", "figures", "exploratory-figures", "pctupreg_sarc_distribution.png")
ggsave(filename = figure_file, plot=p3) 

```

P3: This histogram shows that the percentage of unintended pregnancies among those using short acting reversible methods varies more between countries compared to long acting reversible methods. About half of the countries in the dataset report less than 20% of pregnancies are unintended when women use this form of birth control. 


We will now explore the new total usage variables that were created using the number of women using each method across the 'total_sarc' variable. 
```{r}

# Explore the total number of people using Short Acting Reversible Methods in each country
p7 <- mydata %>% ggplot(aes(x=total_sarc)) + 
  geom_histogram() + 
  ggtitle("Total Usage of Short Acting Reversible Methods per Country") + xlab("Number of Women") + ylab("Number of Countries")
plot(p7)
figure_file = here("results", "figures", "exploratory-figures", "total_sarc_distribution.png")
ggsave(filename = figure_file, plot=p7) 

```

The outliers were explored and addressed in the processing-file.qmd in the code > processing-code folder. Now that we have standardized population variables, We will start exploring how many women use each type of birth control in each country compared to the percent of unintended pregnancies related to that birth control. 

Plot 11 uses `pct_upreg_sarc` and `sarc_standard` to examine the same relationship as plot 10 but with short-acting reversible methods. 
```{r}

# explore percentage of unintended pregnancies compared to standardized count of women using short acting reversible methods
p11 <- mydata %>% ggplot(aes(x=pct_upreg_sarc, y=sarc_standard)) + 
  geom_point() + 
  geom_smooth(method='lm') + 
  ggtitle("Percent of Unintended Pregnancies vs Standardzied Count of Women Using SARCs") + xlab("Percentage of Unintended Pregnancies") + ylab("Standarized Total Number of Women")
plot(p11)
figure_file = here("results", "figures", "exploratory-figures", "pctupreg_totalsarc.png")
ggsave(filename = figure_file, plot=p11) 

```


P11: The same positive trend is shown between the percentage of unintended pregnancies and number of women using SARMs, but there is considerably more variation in this relationship. 


We are also interested in how these relationships between percent of unintended pregnancies using Short Acting Reversible Methods and the number of people using each method varies across region. We adjusted the original scatter plots created above by coloring based on region. 

```{r}

# explore percent unintended pregnancies using short acting reversible methods by region
p15 <- mydata %>% ggplot(aes(x=pct_upreg_sarc, y=sarc_standard, color = region)) + 
  geom_point() + 
  geom_smooth(method='lm') + 
  ggtitle("Percent of Unintended Pregnancies vs Standardzied Count of Women Using SARCs") + xlab("Percentage of Unintended Pregnancies") + ylab("Standarized Total Number of Women")
plot(p15)
figure_file = here("results", "figures", "exploratory-figures", "pctupreg_sarc_stratified.png")
ggsave(filename = figure_file, plot=p15) 

```

P15: This graph for short acting reversible methods shows clearer differences between regions, and Latin America/the Caribbean leads in the percentage of unintended pregnancies in this category, but Africa shows the sharpest increase in percentage of unintended pregnancies as the total population increases.  


Our next group of plots will be violin plots to explore the usage level of Short Acting Reversible Methods, a categorical variable, associated with percentage of unintended pregnancies use for each birth control method, a numerical variable.
```{r}

# explore short acting reversible method usage compared to percent of unintended pregnancies
p19 <- mydata %>% ggplot(aes(x = sarc_usage, y = pct_upreg_sarc)) +
  geom_violin() + ggtitle("Usage of SARCs vs Percent of Unintended Pregnancies") +
  labs(x = "Short Acting Reversible Usage", y = "Percentage Unintended Pregnancies") 
plot(p19)
figure_file = here("results", "figures", "exploratory-figures", "sarc_pctupreg_violin.png")
ggsave(filename = figure_file, plot=p19) 

```

P19: It appears that the distribution of short acting reversible method usage is skewed towards lower percentages of unintended pregnancies across all usage levels, suggesting that more countries have lower percentage of unintended pregnancies among women using this method. 

