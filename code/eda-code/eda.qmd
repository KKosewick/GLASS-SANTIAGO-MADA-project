---
title: "Exploratory Analysis Script"
author: "Taylor Glass and Arlyn Santiago"
date: "02/21/24"
output: html_document
---

# Setup

```{r}
#load needed packages. make sure they are installed.
library(here) #for data loading/saving
library(dplyr)
library(skimr)
library(ggplot2)
```

Load the data.

```{r}
#Path to data
data_location <- here("data","processed-data","processeddata.rds")
#load data
mydata <- readRDS(data_location)
```


# Data exploration through tables
We will begin with creating a summary table of our cleaned variables using the skim()function. This provides information about each of the numeric variables including the mean, standard deviation, quartiles, missing observations, and a histogram. 

```{r}
# skim the data to create summary file
summary_df = skim(mydata)
print(summary_df)
# save to file
summarytable_file = here("results", "tables", "summarytable.rds")
saveRDS(summary_df, file = summarytable_file)
```
We also created simple tables for the categorical variables: `region`, `larcster_usage`, `sarc_usage`, and `none_usage`.
```{r}
library(gtsummary)
tabl1 <- mydata %>% select(`region`)
tabl2 <- mydata %>% select(`larcster_usage`)
tabl3 <- mydata %>% select(`sarc_usage`)
tabl4 <- mydata %>% select(`none_usage`)
```


# Data exploration through figures

We will make histogram plots for the continuous outcomes in our dataset.

It is important to consider the type of birth control methods associated with percent of unintended pregnancies as well. We will create a histogram for the `pct_upreg_larcster`, `pct_upreg_sarc`, `pct_upreg_trad`, and `pct_upreg_nouse` variables.  

```{r}
# explore the percentage of unintended pregnancies related to long acting reversible methods in each country
p2 <- mydata %>% ggplot(aes(x=pct_upreg_larcster)) + geom_histogram() + ggtitle("Percent Unintended Pregnancy Using Long Acting Reversible Methods") + xlab("Number of Countries") + ylab("Percent")
plot(p2)
figure_file = here("results", "figures", "exploratory-figures", "pctupreg_larcster_distribution.png")
ggsave(filename = figure_file, plot=p2) 

# explore the percentage of unintended pregnancies related to short acting reversible methods in each country
p3 <- mydata %>% ggplot(aes(x=pct_upreg_sarc)) + geom_histogram() + ggtitle("Percent Unintended Pregnancy Using Short Acting Reversible Methods") + xlab("Number of Countries") + ylab("Percent")
plot(p3)
figure_file = here("results", "figures", "exploratory-figures", "pctupreg_sarc_distribution.png")
ggsave(filename = figure_file, plot=p3) 

# explore the percentage of unintended pregnancies related to traditional methods in each country
p4 <- mydata %>% ggplot(aes(x=pct_upreg_trad)) + geom_histogram() + ggtitle("Percent Unintended Pregnancy Using Traditional Methods") + xlab("Number of Countries") + ylab("Percent")
plot(p4)
figure_file = here("results", "figures", "exploratory-figures", "pctupreg_trad_distribution.png")
ggsave(filename = figure_file, plot=p4) 

# explore the percentage of unintended pregnancies related to no birth control usage in each country
p5 <- mydata %>% ggplot(aes(x=pct_upreg_nouse)) + geom_histogram() + ggtitle("Percent Unintended Pregnancy Using No Birth Control") + xlab("Number of Countries") + ylab("Percent")
plot(p5)
figure_file = here("results", "figures", "exploratory-figures", "pctupreg_nouse_distribution.png")
ggsave(filename = figure_file, plot=p5) 
```
P2: This histogram shows that the percentage of unintended pregnancies is very low, at around 2%. 

P3: This histogram shows that the percentage of unintended pregnancies is very low, even for people who do not use SARMs. For example, the graph shows that among people who used a SARM 30% of the time, about 2.8% experienced an unintended pregnancy.

P4: This histogram shows that the percentage of unintended pregnancies decreases as the use of traditional methods increases. 

P5: This histogram shows that the percentage of unintended pregnancies among women who do not use any contraception varies widely by country.

We will now explore the new total usage variables that were created using the number of women using each method across the four age categories. This set of plots revealed large outliers in the 'total_larcster`, 'total_sarc', 'total_trad', and `total_none` variables, which prevented the graphs from being very useful. The histograms look like most observations for each of these four variables are 0, but that is not possible because the summary table showed that the minimum value for all four of these variables is greater than 0. This distortion is caused by the two large outliers in the data set.    

```{r}
# explore the total number of people using long acting reversible methods in each country
p6 <- mydata %>% ggplot(aes(x=total_larcster)) + geom_histogram() + ggtitle("Total Usage of Long Acting Reversible Methods per Country") + xlab("Population") + ylab("Percent")
plot(p6)
figure_file = here("results", "figures", "exploratory-figures", "total_larcster_distribution.png")
ggsave(filename = figure_file, plot=p6) 

# explore the total number of people using short acting reversible methods in each country
p7 <- mydata %>% ggplot(aes(x=total_sarc)) + geom_histogram() + ggtitle("Total Usage of Short Acting Reversible Methods per Country") + xlab("Population") + ylab("Percent")
plot(p7)
figure_file = here("results", "figures", "exploratory-figures", "total_sarc_distribution.png")
ggsave(filename = figure_file, plot=p7) 

# explore the total number of people using traditional methods in each country
p8 <- mydata %>% ggplot(aes(x=total_trad)) + geom_histogram() + ggtitle("Total Usage of Traditional Methods per Country") + xlab("Population") + ylab("Percent")
plot(p8)
figure_file = here("results", "figures", "exploratory-figures", "total_trad_distribution.png")
ggsave(filename = figure_file, plot=p8) 

# explore the total number of people not using birth control in each country
p9 <- mydata %>% ggplot(aes(x=total_none)) + geom_histogram() + ggtitle("Total Usage of No Birth Control Method per Country") + xlab("Population") + ylab("Percent")
plot(p9)
figure_file = here("results", "figures", "exploratory-figures", "total_none_distribution.png")
ggsave(filename = figure_file, plot=p9) 
```
P6: There appears to be more countries with a lower percentage of LARC usage (around 20-30%) compared to countries with a higher percentage (around 60-70%).

P7: There appears to be more countries with a lower population and higher percentage of SARC usage.

P8: This histogram seems to suggest that there are variations in traditional method usage between different countries.

P9: I'm not sure with this one. 

We need to explore where the outliers in these variables are coming from. China and India are the two countries that account for the outliers in all 4 variables, which is likely being skewed by population size. The first method of standardizing we tried is creating proportions using the total count for each birth control method type. After creating these standardized variables, the same issue with outliers remained because China and India still account for the largest proportion of observations. Next, we considered using a scaling factor. We attempted this approach with the `total_larcster` variable and found the same issues as before. The third attempt at standarization utilized a min-max scaling with z-score normalization, but the outlier issue remained. 
```{r}
# find the countries that represent the outliers
outliers <- mydata %>% filter(total_larcster > 25000, 
                              total_sarc > 25000,
                              total_trad > 5000,
                              total_none > 10000)

# standardization attempt 1
mydata <- mydata %>% mutate(larcster_st = total_larcster / sum(total_larcster),
                            sarc_st = total_sarc / sum(total_sarc),
                            trad_st = total_trad / sum(total_trad),
                            none_st = total_none / sum(total_none))

# standardization attempt 2
scaling_factor_larcster <- max(mydata$total_larcster)
mydata <- mydata %>% mutate(standardized_larcster = total_larcster / scaling_factor_larcster)

# standardization attempt 3
min_count <- min(mydata$total_larcster)
max_count <- max(mydata$total_larcster)
scaled_counts <- (mydata$total_larcster - min_count) / (max_count - min_count)
print(scaled_counts)
mean_count <- mean(mydata$total_larcster)
sd_count <- sd(mydata$total_larcster)
z_score_counts <- (mydata$total_larcster - mean_count) / sd_count
```

After reviewing the raw data set again, we found the `wra` variable that accounts for the number of women of reproductive age (15-49) in each country. Once this variable was added to the original processed data set, we could use it to standardize the total counts for each birth control method by population size of women of reprodutive age. 
```{r}
# population size standarization for total counts per birth control method
mydata <- mydata %>% mutate(larcster_standard = total_larcster / wra,
                            sarc_standard = total_sarc / wra,
                            trad_standard = total_trad / wra, 
                            none_standard = total_none / wra)
```

We will start exploring how many women use each type of birth control in each country compared to the percent of unintended pregnancies related to that birth control. Plot 10 shows `pct_upreg_larcster` vs `larcster_standard` to analyze women using long acting reversible methods and sterilization versus the percentage of unintended pregnancies using those methods. Plot 11 uses `pct_upreg_sarc` and `sarc_standard` to examine the same relationship as plot 10 but with short-acting reversible methods. Plot 12 shows `pct_upreg_trad` versus `trad_standard`, and plot 13 shows `pct_upreg_nouse` versus `none_standard`. 
```{r}
# explore percentage of unintended pregnancies compared to standardized count of women using long-acting reversible and sterilization methods
p10 <- mydata %>% ggplot(aes(x=pct_upreg_larcster, y=larcster_standard)) + geom_point() + geom_smooth(method='lm') + ggtitle("Percent of Unintended Pregnancies vs Standardzied Count of Women Using LARCs") + xlab("Standardized Count of Women") + ylab("Percent")
plot(p10)
figure_file = here("results", "figures", "exploratory-figures", "pctuppreg_totallarcster.png")
ggsave(filename = figure_file, plot=p10) 

# explore percentage of unintended pregnancies compared to standardized count of women using short acting reversible methods
p11 <- mydata %>% ggplot(aes(x=pct_upreg_sarc, y=sarc_standard)) + geom_point() + geom_smooth(method='lm') + ggtitle("Percent of Unintended Pregnancies vs Standardzied Count of Women Using SARCs") + xlab("Standardized Count of Women") + ylab("Percent")
plot(p11)
figure_file = here("results", "figures", "exploratory-figures", "pctupreg_totalsarc.png")
ggsave(filename = figure_file, plot=p11) 

# explore percentage of unintended pregnancies compared to standardized count of women using traditional methods
p12 <- mydata %>% ggplot(aes(x=pct_upreg_trad, y=trad_standard)) + geom_point() + geom_smooth(method='lm') + ggtitle("Percent of Unintended Pregnancies vs Standardzied Count of Women Using Traditional Methods") + xlab("Standardized Count of Women") + ylab("Percent")
plot(p12)
figure_file = here("results", "figures", "exploratory-figures", "pctupreg_totaltrad.png")
ggsave(filename = figure_file, plot=p12) 

# explore percentage of unintended pregnancies compared to standardized count of women not using no method
p13 <- mydata %>% ggplot(aes(x=pct_upreg_nouse, y=none_standard)) + geom_point() + geom_smooth(method='lm') + ggtitle("Percent of Unintended Pregnancies vs Standardzied Count of Women Using No Method") + xlab("Standardized Count of Women") + ylab("Percent")
plot(p13)
figure_file = here("results", "figures", "exploratory-figures", "pctupreg_totalnone.png")
ggsave(filename = figure_file, plot=p13) 
```

P10: As the standardized count of women using LARCs and sterilization methods increases, the percentage of unintended pregnancies tends to decrease.

P11: As the standardized count of women using contraception increases, the percentage of unintended pregnancies might decrease. There appears to be a great amount of variation within the standardized count. 

P12: I'm not sure with this one. 

P13: There appears to be a variation in unintended pregnancy rates across different countries.


We are also interested in how these relationships between percent of unintended pregnancies using each birth control method and the number of people using each method varies across region. We adjusted the original scatter plots created above by coloring based on region. 

```{r}
# explore percent unintended pregnancies using long acting reversible and sterilziation methods by region
p14 <- mydata %>% ggplot(aes(x=pct_upreg_larcster, y=larcster_standard, color = region)) + geom_point() + geom_smooth(method='lm') + ggtitle("Percent of Unintended Pregnancies Using LARCs and Sterilzation Methods By Region") + xlab("Number of Regions") + ylab("Percent")
plot(p14)
figure_file = here("results", "figures", "exploratory-figures", "pctupreg_larcster_stratified.png")
ggsave(filename = figure_file, plot=p14) 

# explore percent unintended pregnancies using short acting reversible methods by region
p15 <- mydata %>% ggplot(aes(x=pct_upreg_sarc, y=sarc_standard, color = region)) + geom_point() + geom_smooth(method='lm') + ggtitle("Percent of Unintended Pregnancies Using SARCs Methods By Region") + xlab("Number of Regions") + ylab("Percent")
plot(p15)
figure_file = here("results", "figures", "exploratory-figures", "pctupreg_sarc_stratified.png")
ggsave(filename = figure_file, plot=p15) 

# explore percent unintended pregnancies using traditional methods by region
p16 <- mydata %>% ggplot(aes(x=pct_upreg_trad, y=trad_standard, color = region)) + geom_point() + geom_smooth(method='lm') + ggtitle("Percent of Unintended Pregnancies Using Traditional Methods By Region") + xlab("Number of Regions") + ylab("Percent")
plot(p16)
figure_file = here("results", "figures", "exploratory-figures", "pctupreg_trad_stratified.png")
ggsave(filename = figure_file, plot=p16) 

# explore percent unintended pregnancies using no method by region
p17 <- mydata %>% ggplot(aes(x=pct_upreg_nouse, y=none_standard, color = region)) + geom_point() + geom_smooth(method='lm') + ggtitle("Percent of Unintended Pregnancies Using No Methods By Region") + xlab("Number of Regions") + ylab("Percent")
plot(p17)
figure_file = here("results", "figures", "exploratory-figures", "pctupreg_none_stratified.png")
ggsave(filename = figure_file, plot=p17) 
```
P14: There appears to be a negative correlation. As the standardized count of women using contraception increases, the percentage of unintended pregnancies tends to decrease. However, the strength of this relationship is difficult to determine.

P15: I'm not sure. 

P16: There appears to be a positive correlation. As the percentage of women not using contraception increases, the percentage of unintended pregnancies also tends to increase.

P17: There appears to be a greater overall variation in the No Methods usage per region. The strength of this relationship is difficult to determine. 

Our next group of plots will be violin plots to explore the usage level of each birth control method, a categorical variable, associated with percentage of unintended pregnancies use for each birth control method, a numerical variable.
```{r}
# explore long acting reversible and sterilization method usage compared to percent of unintended pregnancies
p18 <- mydata %>% ggplot(aes(x = larcster_usage, y = pct_upreg_larcster)) +
  geom_violin() + ggtitle("Usage of LARCs and Sterilization vs Percent of Unintended Pregnancies") +
  labs(x = "Long Acting Reversible and Sterilization Usage", y = "Percentage Unintended Pregnancies") 
plot(p18)
figure_file = here("results", "figures", "exploratory-figures", "larcster_pctupreg_violin.png")
ggsave(filename = figure_file, plot=p18) 

# explore short acting reversible method usage compared to percent of unintended pregnancies
p19 <- mydata %>% ggplot(aes(x = sarc_usage, y = pct_upreg_sarc)) +
  geom_violin() + ggtitle("Usage of SARCs vs Percent of Unintended Pregnancies") +
  labs(x = "Short Acting Reversible Usage", y = "Percentage Unintended Pregnancies") 
plot(p19)
figure_file = here("results", "figures", "exploratory-figures", "sarc_pctupreg_violin.png")
ggsave(filename = figure_file, plot=p19) 

# explore traditional method usage compared to percent of unintended pregnancies
p20 <- mydata %>% ggplot(aes(x = trad_usage, y = pct_upreg_trad)) +
  geom_violin() + ggtitle("Usage of Traditional Method vs Percent of Unintended Pregnancies") +
  labs(x = "Traditional Method Usage", y = "Percentage Unintended Pregnancies") 
plot(p20)
figure_file = here("results", "figures", "exploratory-figures", "trad_pctupreg_violin.png")
ggsave(filename = figure_file, plot=p20) 

# explore no method usage compared to percent of unintended pregnancies
p21 <- mydata %>% ggplot(aes(x = none_usage, y = pct_upreg_nouse)) +
  geom_violin() +  ggtitle("No Birth Control Usage vs Percent of Unintended Pregnancies") +
  labs(x = "No Birth Control Usage", y = "Percentage Unintended Pregnancies") 
plot(p21)
figure_file = here("results", "figures", "exploratory-figures", "none_pctupreg_violin.png")
ggsave(filename = figure_file, plot=p21) 
```
P18: It would appear that countries with higher percentages of sterilized women might have lower percentages of unintended pregnancies.

P19: It would appear that the distribution of SARC usage might be skewed towards lower percentages, suggesting that more countries have lower SARC usage compared to those with higher SARC usage.

P20: It would appear that as the percentage of women who have ever used the traditional method increases, the percentage of unintended pregnancies tends to decrease. However, the strength of this relationship is difficult to determine.

P21: It would appear that as the percentage of women who do not use a birth control method increases, the percentage of unintended pregnancies tends to inccrease. 

