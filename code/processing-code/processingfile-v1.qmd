---
title: "Processing Script"
author: "Taylor Glass and Arlyn Santiago"
date: "2024-02-16"
output: html_document
---


# Processing script

# Setup

Load the necessary packages for data loading and processing. 

```{r}
library(readr) # for loading csv files
library(readxl) # for loading excel files (codebook)
library(dplyr) #for data processing/cleaning
library(tidyr) #for data processing/cleaning
library(naniar) #to explore data missingness
library(skimr) #for nice visualization of data 
library(here) #to set paths
library(tidymodels) #to impute missing data
library(recipes) #to impute missing data
```


# Data loading

```{r}
# path to data using here() function
data_location <- here("data","raw-data","AIU All Women Dataset.csv")
rawdata <- read_csv(data_location)
```

# Check data

We will load and examine the codebook first. 

```{r}
# write file path to the codebook
codebook_location <- here("data", "AIU All Women Dataset Codebook.xlsx")
  
# specify the 3 sheets of the codebook we need 
sheets <- c("Demographics", "Contraceptive need & use", "Pregnancy-related & newborn")

# load codebook
codebook <- lapply(sheets, function(sheet) {
  readxl::read_excel(codebook_location, sheet = sheet)
})
print(codebook)
```
Note: should we include other covariates like marriage percentages, number of live births, number of induced abortions

# Glimpse at the data

We will take a glimpse at our data to better understand the variables we are working with. There are four character variables: `country`, `data_source_year`, `region`, and `subregion`. The remainder of the variables are numeric and describe percentage of birth outcomes, maternal deaths due to birth outcomes, contraceptive methods divided by age groups, wealth levels in relation to contraceptive methods, various abortion procedure rates, current cost of pregnancy outcomes and STI treatment.

```{r}
dplyr::glimpse(rawdata)
summary(rawdata)
head(rawdata)
skimr::skim(rawdata)
```
# Identifying variables to be cleaned 

```{r}
rawdata2 <- rawdata %>% 
                select(country, region, subregion, pct_upreg, upreg_subreg, modmethods_3549, ster_3549, larc_3549, sarc_3549, tradmethods_3549, nomethod_3549)

skimr::skim(rawdata2)
```

# Cleaning

By inspecting the data as done above, we find some problems that need addressing:

First, the `region` variable is a character variable, but it will be more useful later as a factor. We can easily mutate it from a character variable to factor variable. All the remaining variables are numeric as they should be. 
```{r}
# convert character variable to factor variable
rawdata2 <- rawdata2 %>% 
              mutate(region = as.factor(region))

# check that the conversion worked 
class(rawdata2$region)
```

Second, there are 24 entries missing for the percentage of all unintended pregnancies by country `pct_upreg`, which accounts for 18.18% of the observations. After isolating the observations with this missing variable, we see that the majority of countries in this category are located in Asia. This does not make sense because the majority of countries in the raw dataset are located in Africa, which suggests that the data are not missing at random. 
```{r}
# find missing percentage for each variable
miss_var_summary(rawdata2)

# isolate the percentage of all unintended pregnancies by country to discover trends in missingness 
variable_with_missing <- "pct_upreg"
missing_obs <- rawdata2[is.na(rawdata2[[variable_with_missing]]), ]
other_variables <- colnames(rawdata2)[!colnames(rawdata2) == variable_with_missing]
pct_upregmissing <- missing_obs[, other_variables]
print(pct_upregmissing)

# compare dataset with the missing variable to the full dataset
table(pct_upregmissing$region)
table(rawdata2$region)
```

We should impute the missing data here to avoid introducing bias because 18.18% of the data is missing, and this variable is the best outcome variable to answer the research question. After finding the summary statistics of this variable, the median is 0.4701 and the mean is 0.4679, which suggests that there are minimal outliers in the data.  
```{r}
# find mean to use for imputed data
summary(rawdata2$pct_upreg)

# create a recipe to impute data 
rec <- recipe(pct_upreg ~ ., data = rawdata2) %>%
  step_naomit(all_predictors(), -all_outcomes(), skip = TRUE) %>%
  step_impute_mean(all_predictors()) #which predictors would I use?

# prepare the raw data using the recipe
data_prep <- prep(rec, training = rawdata2)

# impute the data 
data_imputed <- bake(data_prep, new_data = NULL) #all pct_upreg are NaN values 

# identify rows with missing values in the original dataset
missing_rows <- which(is.na(rawdata2$pct_upreg))

# replace missing values in the original dataset with imputed values
rawdata2$pct_upreg[missing_rows] <- data_imputed$pct_upreg[missing_rows]

```
Once the missing values have been imputed, we should further clean the `pct_upreg` variable to have a typical percentage format. 
```{r}
rawdata2 <- rawdata2 %>% 
              mutate(pct_upreg = pct_upreg * 100)
```

We also need to evaluate the 108 missing entries of the percentage of unintended pregnancies by subregion `upreg_subreg`. Since 81.81% of this variable is missing, it does not make sense to include it in the analysis because we do not have enough information to impute the missing data. We will remove this variable for the sake of this analysis.
```{r}
# isolate the percentage of all unintended pregnancies by subregion to discover trends in missingness
variable_with_missing <- "upreg_subreg"
missing_obs2 <- rawdata2[is.na(rawdata2[[variable_with_missing]]), ]
other_variables2 <- colnames(rawdata2)[!colnames(rawdata2) == variable_with_missing]
pct_subregmissing <- missing_obs2[, other_variables2]
print(pct_subregmissing)

# remove unintended pregnancies by subregion variable due to missingness
rawdata2 <- rawdata2 %>% 
              select(-upreg_subreg)
```

Each of the variables about birth control methods, `mod_methods3549`, `ster_3549`, `larc_3549`, `sarc_3549`, `tradmethods_3549`, `nomethod_3549`, are not very intuitive, so they should be renamed. Since we are only studying one age group, 35 to 49 years, it is unnecessary for those numbers to be included in each variable name. It also makes sense to rename `pct_upreg` to be more descriptive since we already know it is percentage format. 
```{r}
# rename predictor variables
rawdata2 <- rawdata2 %>% rename(modern = modmethods_3549,
                                sterile = ster_3549, 
                                longactrev = larc_3549,
                                shortact = sarc_3549,
                                tradition = tradmethods_3549,
                                nomethod = nomethod_3549,
                                unint_preg = pct_upreg)
# check if renaming worked
head(rawdata2)
```
To answer our research question about how unintended pregnancies are related to birth control methods, it makes sense to have a variable with the total number of women using birth control in each country. This will service as the main predictor variable, and each type of birth control can serve as a covariate. 
```{r}
# create new variable with total number on birth control of any form
rawdata2 <- rawdata2 %>% 
              mutate(totalbc = modern + sterile + longactrev + shortact + tradition + nomethod)

# check new variable is created 
head(rawdata2)
```

Lastly, we will assign the clean data to a final variable, which makes it easier to add further cleaning steps above if necessary.

```{r}
processeddata <- rawdata2
```


# Save data 

Finally, we will save the clean data as RDS file to preserve coding like factors, characters, numeric, etc. 

```{r}
save_data_location <- here("data","processed-data","processeddata.rds")
saveRDS(processeddata, file = save_data_location)
```


